---
- name: Create Cortex config directory
  file:
    path: /var/lib/containers/cortex-config/
    mode: '0775'
    state: directory

# FIX
- name: Set Cortex conf file
  template:
    src: 'cortex.yaml'
    dest: '/var/lib/containers/cortex-config/cortex.yaml'
    mode: '0644'

- name: Create Distributor pods
  containers.podman.podman_pod:
    name: 'cortex-distributor-{{ item }}-pod'
    state: started
    network: '{{ cortex_podman_network }}'
    hostname: 'cortex-distributor-{{ item|string + "." + cortex_domain }}'
  loop: '{{ range(0, cortex_distributor_replicas)|list }}'

- name: Setup Cortex Distributors
  containers.podman.podman_container:
    name: 'cortex-distributor-{{ item }}'
    image: 'quay.io/cortexproject/cortex:{{ cortex_version }}'
    pod: 'cortex-distributor-{{ item }}-pod'
    conmon_pidfile: '/var/lib/containers/pids/cortex-distributor-{{ item }}.pid'
    volume:
      - '/var/lib/containers/cortex-config/cortex.yaml:/etc/cortex.yaml:Z'
    command: '-target=distributor -config.file=/etc/cortex.yaml'
    state: started
#    restart_policy: always
  loop: '{{ range(0, cortex_distributor_replicas)|list }}'

- name: Create Ingesters pods
  containers.podman.podman_pod:
    name: 'cortex-ingester-{{ item }}-pod'
    state: started
    network: '{{ cortex_podman_network }}'
    hostname: 'cortex-ingester-{{ item|string + "." + cortex_domain }}'
  loop: '{{ range(0, cortex_ingester_replicas)|list }}'

# Create and mount WAL directories

- name: Setup Cortex Ingesters
  containers.podman.podman_container:
    name: 'cortex-ingester-{{ item }}'
    image: 'quay.io/cortexproject/cortex:{{ cortex_version }}'
    pod: 'cortex-ingester-{{ item }}-pod'
    conmon_pidfile: '/var/lib/containers/pids/cortex-ingester-{{ item }}.pid'
    volume:
      - '/var/lib/containers/cortex-config/cortex.yaml:/etc/cortex.yaml:Z'
    command: '-target=ingester -config.file=/etc/cortex.yaml'
    state: started
#    restart_policy: always
  loop: '{{ range(0, cortex_ingester_replicas)|list }}'

#- name: Generate systemd files for Cortex cluster
#  include_tasks: systemd.yml
#  loop:
#    - cortex-server0
#    - cortex-server1
#    - cortex-server2
